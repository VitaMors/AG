<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abyss Guardians - RuneScape Clan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes starfield {
            0% { transform: translateY(0px); }
            100% { transform: translateY(-100vh); }
        }
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: starfield linear infinite;
        }
        .star:nth-child(1) { left: 10%; width: 1px; height: 1px; animation-duration: 3s; animation-delay: 0s; }
        .star:nth-child(2) { left: 20%; width: 2px; height: 2px; animation-duration: 4s; animation-delay: 1s; }
        .star:nth-child(3) { left: 30%; width: 1px; height: 1px; animation-duration: 5s; animation-delay: 0.5s; }
        .star:nth-child(4) { left: 40%; width: 1px; height: 1px; animation-duration: 3.5s; animation-delay: 2s; }
        .star:nth-child(5) { left: 50%; width: 2px; height: 2px; animation-duration: 4.5s; animation-delay: 1.5s; }
        .star:nth-child(6) { left: 60%; width: 1px; height: 1px; animation-duration: 3s; animation-delay: 0.8s; }
        .star:nth-child(7) { left: 70%; width: 1px; height: 1px; animation-duration: 5.5s; animation-delay: 2.5s; }
        .star:nth-child(8) { left: 80%; width: 2px; height: 2px; animation-duration: 4s; animation-delay: 0.2s; }
        .star:nth-child(9) { left: 90%; width: 1px; height: 1px; animation-duration: 3.8s; animation-delay: 1.8s; }
        .star:nth-child(10) { left: 95%; width: 1px; height: 1px; animation-duration: 4.2s; animation-delay: 0.3s; }
    </style>
</head>
<body class="bg-black text-white min-h-screen">
    <!-- Header -->
    <header class="bg-gray-900 border-b border-gray-800 sticky top-0 z-50">
        <nav class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <h1 class="text-2xl font-bold text-cyan-400">Abyss Guardians</h1>
                <div class="hidden md:flex space-x-6">
                    <a href="#mission" class="text-gray-300 hover:text-cyan-400 transition-colors">Mission</a>
                    <a href="#donate" class="text-gray-300 hover:text-cyan-400 transition-colors">Donate</a>
                    <a href="#schedule" class="text-gray-300 hover:text-cyan-400 transition-colors">Schedule</a>
                </div>
                <div id="utc-clock" class="text-sm text-gray-400 font-mono" aria-live="polite"></div>
            </div>
        </nav>
    </header>

    <!-- Hero Section -->
    <section class="relative bg-black py-20 overflow-hidden">
        <!-- Animated Starfield -->
        <div class="absolute inset-0 overflow-hidden">
            <div class="star"></div>
            <div class="star"></div>
            <div class="star"></div>
            <div class="star"></div>
            <div class="star"></div>
            <div class="star"></div>
            <div class="star"></div>
            <div class="star"></div>
            <div class="star"></div>
            <div class="star"></div>
        </div>
        
        <div class="container mx-auto px-4 text-center relative z-10">
            <h2 class="text-5xl md:text-7xl font-bold mb-6 bg-gradient-to-r from-cyan-400 to-purple-500 bg-clip-text text-transparent">
                Protect the Runecrafters.<br>Hunt the PKers.
            </h2>
            <p class="text-xl md:text-2xl text-gray-300 mb-8 max-w-4xl mx-auto">
                Organized Abyss patrols ‚Ä¢ Fair shifts ‚Ä¢ Worlds 3 & 84 ‚Ä¢ UTC-based schedule
            </p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <a href="#" class="bg-purple-600 hover:bg-purple-700 text-white px-8 py-4 rounded-full text-lg font-semibold transition-all hover:scale-105 focus:ring-4 focus:ring-purple-300" aria-label="Join our Discord server">
                    Join Discord
                </a>
                <a href="#schedule" class="bg-cyan-600 hover:bg-cyan-700 text-white px-8 py-4 rounded-full text-lg font-semibold transition-all hover:scale-105 focus:ring-4 focus:ring-cyan-300" aria-label="View patrol schedule">
                    View Schedule
                </a>
            </div>
        </div>
    </section>

    <!-- Mission Section -->
    <section id="mission" class="py-20 bg-gray-900">
        <div class="container mx-auto px-4">
            <h3 class="text-4xl font-bold text-center mb-12 text-cyan-400">Our Mission</h3>
            <div class="max-w-4xl mx-auto text-center mb-16">
                <p class="text-lg text-gray-300 leading-relaxed">
                    Deep within the Abyss, where runecrafters risk their lives for precious essence, chaos reigns. 
                    PKers lurk in the shadows, preying on innocent crafters. We are the Abyss Guardians ‚Äì elite warriors 
                    who turn the hunter into the hunted. Our mission: patrol the Abyss, eliminate PKer threats, and 
                    ensure safe passage for all runecrafters. When PKers come for the crafters, they'll find us waiting.
                </p>
            </div>
            
            <div class="grid md:grid-cols-3 gap-8">
                <div class="bg-gray-800 rounded-2xl p-8 hover:scale-105 transition-transform shadow-lg">
                    <div class="text-cyan-400 text-4xl mb-4">üõ°Ô∏è</div>
                    <h4 class="text-xl font-semibold mb-4 text-white">Organized Patrols</h4>
                    <p class="text-gray-300">Coordinated sweeps through Abyss zones with strategic positioning and real-time communication.</p>
                </div>
                
                <div class="bg-gray-800 rounded-2xl p-8 hover:scale-105 transition-transform shadow-lg">
                    <div class="text-purple-400 text-4xl mb-4">‚ö°</div>
                    <h4 class="text-xl font-semibold mb-4 text-white">Rapid Callouts</h4>
                    <p class="text-gray-300">Instant response system for PKer sightings with quick deployment of Guardian squads.</p>
                </div>
                
                <div class="bg-gray-800 rounded-2xl p-8 hover:scale-105 transition-transform shadow-lg">
                    <div class="text-cyan-400 text-4xl mb-4">‚öñÔ∏è</div>
                    <h4 class="text-xl font-semibold mb-4 text-white">Fair Rotations</h4>
                    <p class="text-gray-300">Automated shift scheduling ensuring equal participation and coverage across all time zones.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Donations Section -->
    <section id="donate" class="py-20 bg-black">
        <div class="container mx-auto px-4">
            <h3 class="text-4xl font-bold text-center mb-12 text-purple-400">Support the Guardians</h3>
            
            <div class="grid lg:grid-cols-2 gap-12 max-w-6xl mx-auto">
                <!-- Real Money Support -->
                <div class="bg-gray-900 rounded-2xl p-8">
                    <h4 class="text-2xl font-semibold mb-6 text-cyan-400">Real Money Support</h4>
                    <p class="text-gray-300 mb-6">Donations help pay clan and site costs. We do not exchange real money for GP.</p>
                    
                    <div class="space-y-4">
                        <a href="#" id="paypal-btn" class="block w-full bg-blue-600 hover:bg-blue-700 text-white py-4 px-6 rounded-xl text-center font-semibold transition-all hover:scale-105 focus:ring-4 focus:ring-blue-300" aria-label="Donate via PayPal">
                            üí≥ Donate via PayPal
                        </a>
                        <a href="#" id="bmac-btn" class="block w-full bg-yellow-600 hover:bg-yellow-700 text-white py-4 px-6 rounded-xl text-center font-semibold transition-all hover:scale-105 focus:ring-4 focus:ring-yellow-300" aria-label="Buy me a coffee">
                            ‚òï Buy Me a Coffee
                        </a>
                    </div>
                </div>

                <!-- GP Donations -->
                <div class="bg-gray-900 rounded-2xl p-8">
                    <h4 class="text-2xl font-semibold mb-6 text-purple-400">GP Donations (In-Game)</h4>
                    
                    <form id="gp-pledge-form" class="space-y-4 mb-6">
                        <div>
                            <label for="donor-rsn" class="block text-sm font-medium text-gray-300 mb-2">RSN (Required)</label>
                            <input type="text" id="donor-rsn" required class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label for="gp-amount" class="block text-sm font-medium text-gray-300 mb-2">Amount GP (Required)</label>
                            <input type="number" id="gp-amount" required min="1" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        
                        <div>
                            <label for="pledge-note" class="block text-sm font-medium text-gray-300 mb-2">Note (Optional)</label>
                            <input type="text" id="pledge-note" class="w-full bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        
                        <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 px-6 rounded-lg font-semibold transition-all hover:scale-105 focus:ring-4 focus:ring-purple-300" aria-label="Submit GP pledge">
                            Pledge GP
                        </button>
                    </form>
                    
                    <div class="text-center space-y-2">
                        <p class="text-sm text-gray-400">This is a pledge log. Please trade in-game to:</p>
                        <button id="copy-treasurer" class="bg-gray-800 hover:bg-gray-700 text-cyan-400 px-4 py-2 rounded-lg font-mono text-sm transition-colors focus:ring-2 focus:ring-cyan-500" aria-label="Copy treasurer RSN to clipboard">
                            <span id="treasurer-rsn">Abyss-Treasurer</span> üìã
                        </button>
                        <button id="clear-pledges" class="block w-full mt-4 bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg text-sm transition-colors focus:ring-2 focus:ring-red-500" aria-label="Clear all local pledges">
                            Clear Local Pledges
                        </button>
                    </div>
                </div>
            </div>

            <!-- Pledges Display -->
            <div class="mt-12 grid lg:grid-cols-2 gap-8 max-w-6xl mx-auto">
                <!-- Recent Pledges -->
                <div class="bg-gray-900 rounded-2xl p-6">
                    <h5 class="text-xl font-semibold mb-4 text-cyan-400">Recent Pledges</h5>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-700">
                                    <th class="text-left py-2 text-gray-300">RSN</th>
                                    <th class="text-right py-2 text-gray-300">Amount</th>
                                    <th class="text-left py-2 text-gray-300">Note</th>
                                </tr>
                            </thead>
                            <tbody id="pledges-table" class="text-gray-300">
                                <tr>
                                    <td colspan="3" class="text-center py-4 text-gray-500">No pledges yet</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Top Supporters -->
                <div class="bg-gray-900 rounded-2xl p-6">
                    <h5 class="text-xl font-semibold mb-4 text-purple-400">Top Supporters</h5>
                    <div id="top-supporters" class="space-y-2">
                        <p class="text-center py-4 text-gray-500">No supporters yet</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Schedule Section -->
    <section id="schedule" class="py-20 bg-gray-900">
        <div class="container mx-auto px-4">
            <h3 class="text-4xl font-bold text-center mb-12 text-cyan-400">Shift Scheduler</h3>
            
            <!-- Tip Callout -->
            <div id="schedule-tip" class="bg-purple-900 border border-purple-700 rounded-lg p-4 mb-8 max-w-4xl mx-auto">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-purple-200">üé© <strong>Smart Hat Draw System:</strong> Fair scheduling with burnout prevention</p>
                        <p class="text-purple-300 text-sm mt-1">Members with fewer assignments get higher chances ‚Ä¢ Prevents back-to-back shifts ‚Ä¢ Auto-syncs with clan roster when available</p>
                    </div>
                    <button id="dismiss-tip" class="text-purple-400 hover:text-purple-300 ml-4" aria-label="Dismiss tip">‚úï</button>
                </div>
            </div>

            <!-- Current Protection Status -->
            <div class="max-w-6xl mx-auto mb-12">
                <div class="grid md:grid-cols-2 gap-8">
                    <!-- World 3 Status -->
                    <div class="bg-gray-800 rounded-2xl p-6 border-l-4 border-cyan-500">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-xl font-semibold text-cyan-400">üåç World 3 Protection</h4>
                            <span id="w3-status" class="px-3 py-1 rounded-full text-sm bg-green-600 text-white">üõ°Ô∏è ACTIVE</span>
                        </div>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300">Current Shift:</span>
                                <span id="w3-shift-time" class="font-mono text-cyan-400">14:00 - 18:00 UTC</span>
                            </div>
                            <div class="space-y-2">
                                <span class="text-gray-300 text-sm">On Duty:</span>
                                <div id="w3-guardians" class="flex flex-wrap gap-2">
                                    <!-- Will be populated by JS -->
                                </div>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-400">Next Shift:</span>
                                <span id="w3-next-shift" class="text-gray-400">18:00 UTC</span>
                            </div>
                        </div>
                    </div>

                    <!-- World 84 Status -->
                    <div class="bg-gray-800 rounded-2xl p-6 border-l-4 border-purple-500">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-xl font-semibold text-purple-400">üåç World 84 Protection</h4>
                            <span id="w84-status" class="px-3 py-1 rounded-full text-sm bg-green-600 text-white">üõ°Ô∏è ACTIVE</span>
                        </div>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-300">Current Shift:</span>
                                <span id="w84-shift-time" class="font-mono text-purple-400">14:00 - 18:00 UTC</span>
                            </div>
                            <div class="space-y-2">
                                <span class="text-gray-300 text-sm">On Duty:</span>
                                <div id="w84-guardians" class="flex flex-wrap gap-2">
                                    <!-- Will be populated by JS -->
                                </div>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-400">Next Shift:</span>
                                <span id="w84-next-shift" class="text-gray-400">18:00 UTC</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Roster Management -->
            <div class="max-w-4xl mx-auto mb-12">
                <div class="bg-gray-800 rounded-2xl p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-xl font-semibold text-cyan-400">Guardian Roster</h4>
                        <div class="flex items-center space-x-2">
                            <span id="api-status" class="px-2 py-1 rounded-full text-xs bg-orange-600 text-white">Placeholder Mode</span>
                            <span id="roster-count-badge" class="px-2 py-1 rounded-full text-xs bg-purple-600 text-white">15 Members</span>
                        </div>
                    </div>
                    
                    <div class="mb-4 p-3 bg-gray-900 rounded-lg">
                        <div class="flex items-center justify-between text-sm">
                            <span class="text-gray-300">RuneScape Clan API:</span>
                            <span id="api-toggle" class="text-gray-500">Disabled (No Clan Yet)</span>
                        </div>
                        <div class="text-xs text-gray-500 mt-1">
                            Schedule auto-generates from this roster every 4 hours
                        </div>
                    </div>
                    
                    <textarea id="roster-textarea" rows="6" placeholder="Clan members will appear here..." class="w-full bg-gray-900 border border-gray-700 rounded-lg px-4 py-3 text-white font-mono text-sm focus:ring-2 focus:ring-cyan-500 focus:border-transparent" readonly></textarea>
                    
                    <div class="mt-4 flex space-x-2">
                        <button id="refresh-roster" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg font-semibold transition-colors focus:ring-2 focus:ring-blue-500" aria-label="Refresh clan member list">
                            üîÑ Refresh Roster
                        </button>
                        <button id="regenerate-schedule" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg font-semibold transition-colors focus:ring-2 focus:ring-green-500" aria-label="Regenerate protection schedule">
                            üé© Regenerate Schedule
                        </button>
                    </div>
                    <button id="debug-schedule" class="mt-2 w-full bg-red-600 hover:bg-red-700 text-white py-1 px-4 rounded-lg text-sm font-semibold transition-colors focus:ring-2 focus:ring-red-500" aria-label="Debug schedule generation">
                        üêõ Debug Schedule (Check Console)
                    </button>
                    <button id="emergency-fix" class="mt-1 w-full bg-yellow-600 hover:bg-yellow-700 text-white py-1 px-4 rounded-lg text-sm font-semibold transition-colors focus:ring-2 focus:ring-yellow-500" aria-label="Emergency fix - force immediate coverage">
                        ‚ö° Emergency Fix (Force Coverage Now)
                    </button>
                    <button id="super-debug" class="mt-1 w-full bg-red-800 hover:bg-red-900 text-white py-1 px-4 rounded-lg text-xs font-semibold transition-colors" onclick="superDebug()">
                        üî• SUPER DEBUG (Force Everything)
                    </button>
                    <button id="force-update" class="mt-1 w-full bg-blue-800 hover:bg-blue-900 text-white py-1 px-4 rounded-lg text-xs font-semibold transition-colors" onclick="forceDisplayUpdate()">
                        üîÑ Force Display Update
                    </button>
                </div>
            </div>

            <!-- Schedule Controls -->
            <div class="max-w-6xl mx-auto mb-8">
                <div class="flex flex-wrap gap-4 justify-center">
                    <button id="export-csv" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors focus:ring-2 focus:ring-blue-500" aria-label="Export schedule as CSV">
                        üìä Export Schedule
                    </button>
                    <button id="view-upcoming" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors focus:ring-2 focus:ring-purple-500" aria-label="View upcoming shifts">
                        üìÖ View Upcoming
                    </button>
                </div>
            </div>

            <!-- Local Time Display -->
            <div class="text-center mb-8">
                <p class="text-gray-400">All times are UTC. Your local time is: <span id="local-time" class="font-mono text-cyan-400"></span></p>
            </div>


        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-black border-t border-gray-800 py-8">
        <div class="container mx-auto px-4 text-center">
            <p class="text-gray-400 text-sm mb-4">
                RuneScape¬Æ is property of Jagex. This fan site is non-commercial community tooling. No RWT.
            </p>
            <a href="#" class="text-cyan-400 hover:text-cyan-300 text-sm transition-colors">
                View on GitHub
            </a>
        </div>
    </footer>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2" aria-live="polite"></div>

    <script>
        // Constants & Storage Keys
        const PAYPAL_LINK = "#";
        const BMAC_LINK = "#";
        const CLAN_TREASURER_RSN = "Abyss-Treasurer";
        const CLAN_NAME = "Abyss Guardians"; // For future API integration
        
        const LS_KEYS = {
            roster: 'abyss_roster',
            schedule: 'abyss_schedule',
            pledges: 'abyss_pledges',
            lastApiUpdate: 'abyss_last_api_update',
            lastScheduleGeneration: 'abyss_last_schedule_gen'
        };

        // RuneScape API Configuration (for future use)
        const RS_API = {
            clanMembersEndpoint: `https://secure.runescape.com/m=clan-hiscores/members_lite.ws?clanName=${encodeURIComponent(CLAN_NAME)}`,
            cacheTimeout: 15 * 60 * 1000, // 15 minutes
            enabled: false // Set to true when clan is created
        };

        // Schedule Configuration
        const SCHEDULE_CONFIG = {
            shiftDurationHours: 4,
            guardiansPerShift: 3,
            worlds: [3, 84],
            regenerateIntervalHours: 4,
            daysAhead: 7
        };

        // State
        let roster = [];
        let currentSchedule = [];
        let pledges = [];

        // Utility Functions
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            const bgColor = type === 'error' ? 'bg-red-600' : type === 'success' ? 'bg-green-600' : 'bg-blue-600';
            toast.className = `${bgColor} text-white px-4 py-2 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full`;
            toast.textContent = message;
            toast.setAttribute('role', 'alert');
            
            document.getElementById('toast-container').appendChild(toast);
            
            setTimeout(() => toast.classList.remove('translate-x-full'), 100);
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function formatDateTime(isoString) {
            return new Date(isoString).toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                timeZone: 'UTC'
            });
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // UTC Clock
        function updateClock() {
            const now = new Date();
            const utcTime = now.toUTCString().slice(17, 25);
            const utcDate = now.toUTCString().slice(0, 16);
            
            const clockEl = document.getElementById('utc-clock');
            if (clockEl) {
                clockEl.textContent = `${utcTime} UTC | ${utcDate}`;
            }
            
            // Update local time display
            const localTimeEl = document.getElementById('local-time');
            if (localTimeEl) {
                localTimeEl.textContent = now.toLocaleString();
            }
        }

        // Storage Functions
        function saveToStorage(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        function loadFromStorage(key, defaultValue = []) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            } catch (e) {
                return defaultValue;
            }
        }

        // Roster Management
        async function fetchClanMembers() {
            if (!RS_API.enabled) {
                return getPlaceholderRoster();
            }

            try {
                const lastUpdate = loadFromStorage(LS_KEYS.lastApiUpdate, 0);
                const now = Date.now();
                
                // Check if we need to update (cache timeout)
                if (now - lastUpdate < RS_API.cacheTimeout) {
                    return loadFromStorage(LS_KEYS.roster, getPlaceholderRoster());
                }

                showToast('Fetching latest clan member list...', 'info');
                
                const response = await fetch(RS_API.clanMembersEndpoint);
                if (!response.ok) throw new Error('API request failed');
                
                const data = await response.text();
                const members = parseClanData(data);
                
                if (members.length > 0) {
                    saveToStorage(LS_KEYS.roster, members);
                    saveToStorage(LS_KEYS.lastApiUpdate, now);
                    showToast(`Updated roster: ${members.length} clan members`, 'success');
                    return members;
                }
            } catch (error) {
                console.error('Failed to fetch clan members:', error);
                showToast('Using cached roster - API unavailable', 'error');
            }
            
            return loadFromStorage(LS_KEYS.roster, getPlaceholderRoster());
        }

        function parseClanData(csvData) {
            // Parse RuneScape clan CSV format
            const lines = csvData.split('\n').slice(1); // Skip header
            return lines
                .map(line => line.split(',')[0]?.trim()) // First column is username
                .filter(name => name && name.length > 0)
                .slice(0, 50); // Limit to 50 members for performance
        }

        function getPlaceholderRoster() {
            return [
                'Rx_Bibby',
                'Abyss_Sentinel', 
                'Rift_Warden',
                'Ether_Knight',
                'Void_Sabre',
                'Shadow_Hunter',
                'Rune_Guardian',
                'Chaos_Slayer',
                'Void_Walker',
                'Dark_Protector',
                'Essence_Keeper',
                'Abyss_Warden',
                'Soul_Defender',
                'Rift_Master',
                'Chaos_Guardian'
            ];
        }

        async function loadRoster() {
            roster = await fetchClanMembers();
            document.getElementById('roster-textarea').value = roster.join('\n');
            updateRosterDisplay();
        }

        function updateRosterDisplay() {
            const countBadge = document.getElementById('roster-count-badge');
            const apiStatus = document.getElementById('api-status');
            const apiToggle = document.getElementById('api-toggle');
            
            if (countBadge) {
                countBadge.textContent = `${roster.length} Members`;
            }
            
            if (apiStatus && apiToggle) {
                if (RS_API.enabled) {
                    apiStatus.textContent = 'Live Sync';
                    apiStatus.className = 'px-2 py-1 rounded-full text-xs bg-green-600 text-white';
                    apiToggle.textContent = 'Active';
                    apiToggle.className = 'text-green-400';
                } else {
                    apiStatus.textContent = 'Placeholder Mode';
                    apiStatus.className = 'px-2 py-1 rounded-full text-xs bg-orange-600 text-white';
                    apiToggle.textContent = 'Disabled (No Clan Yet)';
                    apiToggle.className = 'text-gray-500';
                }
            }
        }

        async function refreshRoster() {
            showToast('Refreshing roster...', 'info');
            roster = await fetchClanMembers();
            document.getElementById('roster-textarea').value = roster.join('\n');
            updateRosterDisplay();
        }

        function enableManualRosterEdit() {
            const textarea = document.getElementById('roster-textarea');
            textarea.removeAttribute('readonly');
            textarea.placeholder = 'Enter one RSN per line...';
            showToast('Manual editing enabled - you can now modify the roster', 'info');
        }

        function saveRoster() {
            const text = document.getElementById('roster-textarea').value;
            roster = text.split('\n')
                .map(name => name.trim())
                .filter(name => name.length > 0)
                .filter((name, index, arr) => arr.indexOf(name) === index); // Remove duplicates
            
            saveToStorage(LS_KEYS.roster, roster);
            document.getElementById('roster-textarea').value = roster.join('\n');
            showToast(`Roster saved with ${roster.length} members`, 'success');
        }

        // Automatic Schedule Generation (Simplified & Reliable)
        function generateAutomaticSchedule(forceRegenerate = false) {
            console.log('=== GENERATE AUTOMATIC SCHEDULE ===');
            
            if (roster.length < 3) {
                showToast(`Need at least 3 clan members for scheduling, only have ${roster.length}`, 'error');
                return;
            }
            
            showToast('Generating 24/7 protection schedule...', 'info');
            
            // Simple approach: Create immediate coverage that works like emergency debug
            const now = new Date();
            const schedule = [];
            
            // Create current shift that definitely covers NOW
            const currentShiftStart = new Date(now.getTime() - (30 * 60 * 1000)); // 30 min ago
            const currentShiftEnd = new Date(now.getTime() + (4 * 60 * 60 * 1000)); // 4 hours from now
            
            // World 3 current shift - use first 3 guardians
            const w3Guardians = roster.slice(0, Math.min(3, roster.length));
            const w3CurrentShift = {
                id: 'auto-w3-current-' + Date.now(),
                startUtcISO: currentShiftStart.toISOString(),
                endUtcISO: currentShiftEnd.toISOString(),
                world: 3,
                assigned: w3Guardians
            };
            
            // World 84 current shift - use next 3 guardians (or repeat if not enough)
            let w84Guardians;
            if (roster.length >= 6) {
                w84Guardians = roster.slice(3, 6);
            } else {
                // If less than 6 guardians, use different ones or repeat
                w84Guardians = roster.slice(0, Math.min(3, roster.length));
            }
            
            const w84CurrentShift = {
                id: 'auto-w84-current-' + Date.now(),
                startUtcISO: currentShiftStart.toISOString(),
                endUtcISO: currentShiftEnd.toISOString(),
                world: 84,
                assigned: w84Guardians
            };
            
            schedule.push(w3CurrentShift, w84CurrentShift);
            
            // Generate next 6 shifts (24 hours coverage)
            for (let shiftNum = 1; shiftNum <= 6; shiftNum++) {
                const shiftStart = new Date(currentShiftEnd.getTime() + ((shiftNum - 1) * 4 * 60 * 60 * 1000));
                const shiftEnd = new Date(shiftStart.getTime() + (4 * 60 * 60 * 1000));
                
                // Rotate guardians for variety
                const rotationOffset = shiftNum % Math.max(1, Math.floor(roster.length / 3));
                
                const w3NextGuardians = [];
                const w84NextGuardians = [];
                
                // Assign guardians with rotation
                for (let i = 0; i < 3; i++) {
                    const w3Index = (rotationOffset * 3 + i) % roster.length;
                    const w84Index = ((rotationOffset + 1) * 3 + i) % roster.length;
                    
                    if (w3Index < roster.length) w3NextGuardians.push(roster[w3Index]);
                    if (w84Index < roster.length) w84NextGuardians.push(roster[w84Index]);
                }
                
                // Ensure we always have at least one guardian
                if (w3NextGuardians.length === 0) w3NextGuardians.push(roster[0]);
                if (w84NextGuardians.length === 0) w84NextGuardians.push(roster[0]);
                
                schedule.push({
                    id: `auto-w3-shift${shiftNum}-` + Date.now(),
                    startUtcISO: shiftStart.toISOString(),
                    endUtcISO: shiftEnd.toISOString(),
                    world: 3,
                    assigned: w3NextGuardians
                });
                
                schedule.push({
                    id: `auto-w84-shift${shiftNum}-` + Date.now(),
                    startUtcISO: shiftStart.toISOString(),
                    endUtcISO: shiftEnd.toISOString(),
                    world: 84,
                    assigned: w84NextGuardians
                });
            }
            
            console.log('‚úÖ Generated reliable schedule:', schedule.length, 'shifts');
            console.log('Current W3 shift:', w3CurrentShift);
            console.log('Current W84 shift:', w84CurrentShift);
            
            currentSchedule = schedule;
            saveToStorage(LS_KEYS.schedule, currentSchedule);
            saveToStorage(LS_KEYS.lastScheduleGeneration, Date.now());
            
            // Force immediate display update
            setTimeout(() => {
                updateCurrentProtectionDisplay();
            }, 100);
            
            showToast(`‚úÖ 24/7 Protection Active! W3: ${w3Guardians.join(', ')} | W84: ${w84Guardians.join(', ')}`, 'success');
        }
        
        function getNextShiftStart() {
            const now = new Date();
            const currentHour = now.getUTCHours();
            
            // Always start from the current 4-hour block to ensure immediate coverage
            const currentShiftStart = Math.floor(currentHour / SCHEDULE_CONFIG.shiftDurationHours) * SCHEDULE_CONFIG.shiftDurationHours;
            
            const shiftStart = new Date(now);
            shiftStart.setUTCHours(currentShiftStart, 0, 0, 0);
            
            return shiftStart;
        }

        // Assignment Logic
        function getAssignmentCounts(schedule = currentSchedule) {
            const counts = {};
            roster.forEach(name => counts[name] = 0);
            
            schedule.forEach(shift => {
                shift.assigned.forEach(name => {
                    if (counts[name] !== undefined) {
                        counts[name]++;
                    }
                });
            });
            
            return counts;
        }

        function assignAllShifts(schedule) {
            console.log(`Assigning guardians to ${schedule.length} shifts`);
            schedule.forEach((shift, index) => {
                const assigned = assignShift(shift, schedule);
                shift.assigned = assigned;
                console.log(`Shift ${index + 1} (World ${shift.world}): assigned ${assigned.length} guardians - ${assigned.join(', ')}`);
            });
        }

        function updateCurrentProtectionDisplay() {
            const now = new Date();
            console.log(`Updating protection display at: ${now.toISOString()}`);
            console.log(`Current schedule has ${currentSchedule.length} shifts`);
            
            // Force UTC clock update
            const clockEl = document.getElementById('utc-clock');
            if (clockEl) {
                const utcTime = now.toUTCString().slice(17, 25);
                const utcDate = now.toUTCString().slice(0, 16);
                clockEl.textContent = `${utcTime} UTC | ${utcDate}`;
            }
            
            // Find current shifts for both worlds
            const currentShifts = {
                3: getCurrentShift(3, now),
                84: getCurrentShift(84, now)
            };
            
            console.log(`Current shift World 3:`, currentShifts[3]);
            console.log(`Current shift World 84:`, currentShifts[84]);
            
            // Update World 3 display
            updateWorldDisplay(3, currentShifts[3]);
            
            // Update World 84 display  
            updateWorldDisplay(84, currentShifts[84]);
            
            // Update local time
            const localTimeEl = document.getElementById('local-time');
            if (localTimeEl) {
                localTimeEl.textContent = now.toLocaleString();
            }
        }

        function getCurrentShift(world, currentTime) {
            // Simplified and more reliable current shift detection
            const currentShift = currentSchedule.find(shift => {
                if (shift.world !== world) return false;
                
                const start = new Date(shift.startUtcISO);
                const end = new Date(shift.endUtcISO);
                const isActive = currentTime >= start && currentTime < end;
                
                return isActive && shift.assigned.length > 0; // Must have assigned guardians
            });
            
            return currentShift;
        }

        function updateWorldDisplay(world, currentShift) {
            const prefix = world === 3 ? 'w3' : 'w84';
            const color = world === 3 ? 'cyan' : 'purple';
            
            const statusEl = document.getElementById(`${prefix}-status`);
            const shiftTimeEl = document.getElementById(`${prefix}-shift-time`);
            const guardiansEl = document.getElementById(`${prefix}-guardians`);
            const nextShiftEl = document.getElementById(`${prefix}-next-shift`);
            
            if (currentShift) {
                // Active protection
                statusEl.innerHTML = 'üõ°Ô∏è ACTIVE';
                statusEl.className = 'px-3 py-1 rounded-full text-sm bg-green-600 text-white';
                
                const start = formatTime(currentShift.startUtcISO);
                const end = formatTime(currentShift.endUtcISO);
                shiftTimeEl.textContent = `${start} - ${end} UTC`;
                
                // Display assigned guardians
                guardiansEl.innerHTML = currentShift.assigned.map(name => 
                    `<span class="bg-gray-700 text-${color}-400 px-2 py-1 rounded-full text-xs">üó°Ô∏è ${name}</span>`
                ).join('');
                
                // Find next shift
                const nextShift = getNextShift(world, new Date(currentShift.endUtcISO));
                if (nextShift) {
                    nextShiftEl.textContent = formatTime(nextShift.startUtcISO) + ' UTC';
                }
            } else {
                // No active protection
                statusEl.innerHTML = '‚ö†Ô∏è OFFLINE';
                statusEl.className = 'px-3 py-1 rounded-full text-sm bg-red-600 text-white';
                shiftTimeEl.textContent = 'No active shift';
                guardiansEl.innerHTML = '<span class="text-gray-500 text-sm">No guardians assigned</span>';
                
                const nextShift = getNextShift(world, new Date());
                if (nextShift) {
                    nextShiftEl.textContent = formatTime(nextShift.startUtcISO) + ' UTC';
                } else {
                    nextShiftEl.textContent = 'Schedule needed';
                }
            }
        }

        function getNextShift(world, afterTime) {
            return currentSchedule
                .filter(shift => shift.world === world && new Date(shift.startUtcISO) > afterTime)
                .sort((a, b) => new Date(a.startUtcISO) - new Date(b.startUtcISO))[0];
        }

        function formatTime(isoString) {
            return new Date(isoString).toLocaleString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                timeZone: 'UTC',
                hour12: false
            });
        }

        function isAdjacent(slot1, slot2) {
            const slot1End = new Date(slot1.endUtcISO);
            const slot2Start = new Date(slot2.startUtcISO);
            const timeDiff = Math.abs(slot2Start - slot1End) / (1000 * 60 * 60); // hours
            return timeDiff <= 2;
        }

        function assignShift(shift, schedule = currentSchedule) {
            console.log(`Assigning shift for World ${shift.world} starting at ${shift.startUtcISO}`);
            const counts = getAssignmentCounts(schedule);
            const available = roster.filter(name => !shift.assigned.includes(name));
            
            console.log(`Available guardians: ${available.length} out of ${roster.length}`);
            console.log(`Assignment counts:`, counts);
            
            if (available.length === 0) {
                console.log('No available guardians for this shift');
                return [];
            }
            
            // Enhanced "Hat Draw" Assignment System
            const fairnessScores = calculateFairnessScores(available, counts, shift, schedule);
            const assigned = performHatDraw(fairnessScores, SCHEDULE_CONFIG.guardiansPerShift);
            
            // Fallback: if hat draw failed, just take first N available
            if (assigned.length === 0 && available.length > 0) {
                console.log('Hat draw failed, using simple assignment');
                return available.slice(0, Math.min(SCHEDULE_CONFIG.guardiansPerShift, available.length));
            }
            
            return assigned;
        }

        function calculateFairnessScores(available, counts, shift, schedule) {
            const scores = [];
            const countValues = Object.values(counts);
            const maxAssignments = countValues.length > 0 ? Math.max(...countValues) : 0;
            const minAssignments = countValues.length > 0 ? Math.min(...countValues) : 0;
            
            // Find adjacent slots for burnout prevention
            const adjacentMembers = getAdjacentSlotMembers(shift, schedule);
            
            available.forEach(member => {
                const assignmentCount = counts[member] || 0;
                
                // Base fairness score (lower assignments = higher score)
                let fairnessScore = maxAssignments - assignmentCount + 1;
                
                // Bonus for members with fewer assignments
                if (assignmentCount === minAssignments) {
                    fairnessScore += 3;
                }
                
                // Penalty for adjacent slot assignments (prevent burnout)
                if (adjacentMembers.has(member)) {
                    fairnessScore = Math.max(1, fairnessScore - 2);
                }
                
                // Add slight randomness for true "hat draw" feel
                const randomBonus = Math.random() * 0.5;
                
                scores.push({
                    name: member,
                    score: fairnessScore + randomBonus,
                    assignments: assignmentCount
                });
            });
            
            return scores.sort((a, b) => b.score - a.score);
        }

        function getAdjacentSlotMembers(shift, schedule) {
            const adjacentMembers = new Set();
            const sortedShifts = [...schedule].sort((a, b) => new Date(a.startUtcISO) - new Date(b.startUtcISO));
            const shiftIndex = sortedShifts.findIndex(s => s.id === shift.id);
            
            // Check previous shift (within 4 hours)
            if (shiftIndex > 0) {
                const prevShift = sortedShifts[shiftIndex - 1];
                const timeDiff = (new Date(shift.startUtcISO) - new Date(prevShift.endUtcISO)) / (1000 * 60 * 60);
                if (timeDiff <= 4) {
                    prevShift.assigned.forEach(name => adjacentMembers.add(name));
                }
            }
            
            // Check next shift (within 4 hours)
            if (shiftIndex < sortedShifts.length - 1) {
                const nextShift = sortedShifts[shiftIndex + 1];
                const timeDiff = (new Date(nextShift.startUtcISO) - new Date(shift.endUtcISO)) / (1000 * 60 * 60);
                if (timeDiff <= 4) {
                    nextShift.assigned.forEach(name => adjacentMembers.add(name));
                }
            }
            
            return adjacentMembers;
        }

        function performHatDraw(scores, needed) {
            const assigned = [];
            const remaining = [...scores];
            
            if (remaining.length === 0) return assigned;
            
            // Create weighted "hat" based on fairness scores
            let attempts = 0;
            while (assigned.length < needed && remaining.length > 0 && attempts < 100) {
                attempts++;
                const totalWeight = remaining.reduce((sum, member) => sum + member.score, 0);
                
                if (totalWeight <= 0) {
                    // If all scores are 0 or negative, just pick randomly
                    const randomIndex = Math.floor(Math.random() * remaining.length);
                    assigned.push(remaining.splice(randomIndex, 1)[0].name);
                    continue;
                }
                
                let random = Math.random() * totalWeight;
                let found = false;
                
                for (let i = 0; i < remaining.length; i++) {
                    random -= remaining[i].score;
                    if (random <= 0) {
                        assigned.push(remaining[i].name);
                        remaining.splice(i, 1);
                        found = true;
                        break;
                    }
                }
                
                // Fallback if rounding errors
                if (!found && remaining.length > 0) {
                    assigned.push(remaining.shift().name);
                }
            }
            
            return assigned;
        }

        function assignAllSlots() {
            if (roster.length === 0) {
                showToast('No members in roster', 'error');
                return;
            }
            
            if (roster.length < 5) {
                showToast('Warning: Roster has fewer than 5 members', 'error');
            }
            
            let assignedCount = 0;
            slots.forEach(slot => {
                if (slot.assigned.length === 0) {
                    slot.assigned = assignSlot(slot);
                    if (slot.assigned.length > 0) {
                        assignedCount++;
                    }
                }
            });
            
            saveToStorage(LS_KEYS.slots, slots);
            renderScheduleTable();
            
            if (assignedCount > 0) {
                showToast(`Assigned guardians to ${assignedCount} slot(s)`, 'success');
            } else {
                showToast('No unassigned slots found', 'info');
            }
        }

        function rerollSlot(slotId) {
            const slot = slots.find(s => s.id === slotId);
            if (!slot) return;
            
            slot.assigned = assignSlot(slot);
            saveToStorage(LS_KEYS.slots, slots);
            renderScheduleTable();
            showToast('Slot re-rolled', 'success');
        }

        function clearSchedule() {
            if (confirm('Are you sure you want to clear the entire schedule? This cannot be undone.')) {
                slots = [];
                saveToStorage(LS_KEYS.slots, slots);
                renderScheduleTable();
                showToast('Schedule cleared', 'success');
            }
        }

        function exportCSV() {
            if (currentSchedule.length === 0) {
                showToast('No schedule to export', 'error');
                return;
            }
            
            const headers = ['Start (UTC)', 'End (UTC)', 'World', 'Guardian 1', 'Guardian 2', 'Guardian 3'];
            const rows = [headers];
            
            const sortedShifts = [...currentSchedule].sort((a, b) => new Date(a.startUtcISO) - new Date(b.startUtcISO));
            
            sortedShifts.forEach(shift => {
                const row = [
                    formatDateTime(shift.startUtcISO),
                    formatDateTime(shift.endUtcISO),
                    shift.world.toString(),
                    shift.assigned[0] || '',
                    shift.assigned[1] || '',
                    shift.assigned[2] || ''
                ];
                rows.push(row);
            });
            
            const csvContent = rows.map(row => 
                row.map(field => `"${field}"`).join(',')
            ).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `abyss_guardians_schedule_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showToast('Schedule exported', 'success');
        }

        // Note: renderScheduleTable removed - using live protection display instead

        // GP Pledges
        function loadPledges() {
            pledges = loadFromStorage(LS_KEYS.pledges, []);
            renderPledges();
        }

        function addPledge(rsn, amount, note) {
            const pledge = {
                id: generateId(),
                rsn: rsn.trim(),
                amount: parseInt(amount),
                note: note.trim(),
                timestamp: new Date().toISOString()
            };
            
            pledges.push(pledge);
            saveToStorage(LS_KEYS.pledges, pledges);
            renderPledges();
        }

        function clearPledges() {
            if (confirm('Are you sure you want to clear all local pledges? This cannot be undone.')) {
                pledges = [];
                saveToStorage(LS_KEYS.pledges, pledges);
                renderPledges();
                showToast('Local pledges cleared', 'success');
            }
        }

        function renderPledges() {
            // Recent pledges table
            const tableBody = document.getElementById('pledges-table');
            if (pledges.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">No pledges yet</td></tr>';
            } else {
                const recentPledges = pledges.slice(-10).reverse();
                tableBody.innerHTML = recentPledges.map(pledge => `
                    <tr class="border-b border-gray-700">
                        <td class="py-2">${pledge.rsn}</td>
                        <td class="py-2 text-right font-mono">${pledge.amount.toLocaleString()} GP</td>
                        <td class="py-2">${pledge.note || '-'}</td>
                    </tr>
                `).join('');
            }
            
            // Top supporters
            const supportersDiv = document.getElementById('top-supporters');
            if (pledges.length === 0) {
                supportersDiv.innerHTML = '<p class="text-center py-4 text-gray-500">No supporters yet</p>';
            } else {
                const totals = {};
                pledges.forEach(pledge => {
                    totals[pledge.rsn] = (totals[pledge.rsn] || 0) + pledge.amount;
                });
                
                const sorted = Object.entries(totals)
                    .sort(([,a], [,b]) => b - a)
                    .slice(0, 10);
                
                supportersDiv.innerHTML = sorted.map(([rsn, total], index) => `
                    <div class="flex justify-between items-center py-2 px-3 bg-gray-800 rounded-lg">
                        <span class="flex items-center">
                            <span class="text-purple-400 font-bold mr-2">#${index + 1}</span>
                            <span>${rsn}</span>
                        </span>
                        <span class="font-mono text-cyan-400">${total.toLocaleString()} GP</span>
                    </div>
                `).join('');
            }
        }

        function copyTreasurerRSN() {
            navigator.clipboard.writeText(CLAN_TREASURER_RSN).then(() => {
                showToast('Treasurer RSN copied to clipboard', 'success');
            }).catch(() => {
                showToast('Failed to copy to clipboard', 'error');
            });
        }

        function emergencyFix() {
            console.log('=== EMERGENCY FIX STARTED ===');
            console.log('Current roster:', roster);
            
            if (roster.length === 0) {
                showToast('ERROR: Roster is empty! Try refreshing roster first.', 'error');
                console.log('ERROR: No roster available');
                return;
            }
            
            if (roster.length < 3) {
                showToast(`ERROR: Need at least 3 guardians, only have ${roster.length}`, 'error');
                return;
            }
            
            showToast('üö® EMERGENCY FIX: Creating immediate coverage...', 'info');
            
            // Create simple current shift coverage that definitely includes NOW
            const now = new Date();
            console.log('Current time:', now.toISOString());
            
            // Start 1 hour ago, end 3 hours from now to ensure we cover current time
            const startTime = new Date(now.getTime() - (1 * 60 * 60 * 1000)); // 1 hour ago
            const endTime = new Date(now.getTime() + (3 * 60 * 60 * 1000));   // 3 hours from now
            
            console.log('Shift time:', startTime.toISOString(), 'to', endTime.toISOString());
            
            // Create emergency schedule
            currentSchedule = [];
            
            // World 3 shift
            const w3Guardians = roster.slice(0, Math.min(3, roster.length));
            const w3Shift = {
                id: 'emergency-w3-' + Date.now(),
                startUtcISO: startTime.toISOString(),
                endUtcISO: endTime.toISOString(),
                world: 3,
                assigned: w3Guardians
            };
            
            // World 84 shift  
            const w84Guardians = roster.length >= 6 ? roster.slice(3, 6) : roster.slice(0, Math.min(3, roster.length));
            const w84Shift = {
                id: 'emergency-w84-' + Date.now(),
                startUtcISO: startTime.toISOString(),
                endUtcISO: endTime.toISOString(),
                world: 84,
                assigned: w84Guardians
            };
            
            currentSchedule.push(w3Shift, w84Shift);
            
            console.log('Emergency schedule created:');
            console.log('World 3:', w3Shift);
            console.log('World 84:', w84Shift);
            
            // Force save and update
            saveToStorage(LS_KEYS.schedule, currentSchedule);
            saveToStorage(LS_KEYS.lastScheduleGeneration, Date.now());
            
            // Force display update
            setTimeout(() => {
                updateCurrentProtectionDisplay();
                showToast(`‚úÖ EMERGENCY COVERAGE ACTIVE! W3: ${w3Guardians.join(', ')} | W84: ${w84Guardians.join(', ')}`, 'success');
            }, 100);
            
            console.log('=== EMERGENCY FIX COMPLETED ===');
        }

        function showUpcomingShifts() {
            const upcomingShifts = currentSchedule
                .filter(shift => new Date(shift.startUtcISO) > new Date())
                .sort((a, b) => new Date(a.startUtcISO) - new Date(b.startUtcISO))
                .slice(0, 20); // Show next 20 shifts
                
            if (upcomingShifts.length === 0) {
                showToast('No upcoming shifts scheduled', 'info');
                return;
            }
            
            // Create a simple display for upcoming shifts
            let content = 'Upcoming Protection Shifts:\n\n';
            upcomingShifts.forEach(shift => {
                const start = new Date(shift.startUtcISO).toLocaleString('en-US', { timeZone: 'UTC' });
                const world = shift.world;
                const guardians = shift.assigned.join(', ') || 'Unassigned';
                content += `${start} UTC - World ${world}: ${guardians}\n`;
            });
            
            // For now, just show in console (can be enhanced with modal later)
            console.log(content);
            showToast('Upcoming shifts logged to console (F12)', 'info');
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', async function() {
            // Set up donation button links
            document.getElementById('paypal-btn').href = PAYPAL_LINK;
            document.getElementById('bmac-btn').href = BMAC_LINK;
            document.getElementById('treasurer-rsn').textContent = CLAN_TREASURER_RSN;
            
            // Load data
            await loadRoster();
            loadPledges();
            
            // Auto-generate schedule immediately with current roster
            setTimeout(() => {
                console.log('üöÄ Auto-generating schedule on page load...');
                console.log('Roster at generation time:', roster);
                if (roster.length > 0) {
                    generateAutomaticSchedule(true); // Force generation
                } else {
                    console.log('‚ùå No roster available, retrying in 2 seconds...');
                    setTimeout(() => {
                        console.log('üîÑ Retry auto-generation...');
                        generateAutomaticSchedule(true);
                    }, 2000);
                }
            }, 1000);
            
            // Also set up regular updates every 30 seconds
            setInterval(() => {
                updateCurrentProtectionDisplay();
            }, 30000);
            
            // Set up event listeners
            document.getElementById('refresh-roster').addEventListener('click', refreshRoster);
            document.getElementById('save-roster').addEventListener('click', () => {
                enableManualRosterEdit();
                setTimeout(() => {
                    document.getElementById('save-roster').onclick = saveRoster;
                    document.getElementById('save-roster').innerHTML = 'üíæ Save Changes';
                }, 100);
            });
            document.getElementById('regenerate-schedule').addEventListener('click', () => {
                generateAutomaticSchedule(true);
            });
            document.getElementById('debug-schedule').addEventListener('click', () => {
                console.log('=== DEBUG SCHEDULE ===');
                console.log('Current roster:', roster);
                console.log('Current schedule:', currentSchedule);
                console.log('Schedule config:', SCHEDULE_CONFIG);
                generateAutomaticSchedule(true);
            });
            document.getElementById('emergency-fix').addEventListener('click', () => {
                emergencyFix();
            });
            document.getElementById('export-csv').addEventListener('click', exportCSV);
            document.getElementById('view-upcoming').addEventListener('click', showUpcomingShifts);
            document.getElementById('copy-treasurer').addEventListener('click', copyTreasurerRSN);
            document.getElementById('clear-pledges').addEventListener('click', clearPledges);
            
            // Update display every minute
            setInterval(() => {
                updateCurrentProtectionDisplay();
                generateAutomaticSchedule(); // Check if regeneration needed
            }, 60000);
            
            // GP Pledge form
            document.getElementById('gp-pledge-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const rsn = document.getElementById('donor-rsn').value.trim();
                const amount = document.getElementById('gp-amount').value;
                const note = document.getElementById('pledge-note').value.trim();
                
                if (!rsn || !amount || amount <= 0) {
                    showToast('Please fill in RSN and a valid GP amount', 'error');
                    return;
                }
                
                addPledge(rsn, amount, note);
                this.reset();
                showToast('GP pledge added', 'success');
            });
            
            // Dismiss tip
            document.getElementById('dismiss-tip').addEventListener('click', function() {
                document.getElementById('schedule-tip').style.display = 'none';
            });
            
            // Start clock immediately and then every second
            updateClock();
            setInterval(updateClock, 1000);
            
            // Force initial display update
            setTimeout(() => {
                console.log('=== INITIALIZATION CHECK ===');
                console.log('UTC clock element exists:', !!document.getElementById('utc-clock'));
                console.log('W3 status element exists:', !!document.getElementById('w3-status'));
                console.log('W84 status element exists:', !!document.getElementById('w84-status'));
                console.log('Emergency button exists:', !!document.getElementById('emergency-fix'));
                
                updateClock();
                updateCurrentProtectionDisplay();
                
                console.log('Initialization completed');
            }, 500);
        });

        // Force Display Update function
        window.forceDisplayUpdate = function() {
            console.log('üîÑ FORCE DISPLAY UPDATE');
            console.log('Current schedule:', currentSchedule);
            console.log('Roster:', roster);
            
            // Force clock update
            updateClock();
            
            // Force protection display update
            updateCurrentProtectionDisplay();
            
            console.log('‚úÖ Display update forced');
        };

        // Global debug function
        window.superDebug = function() {
            console.log('üî• SUPER DEBUG ACTIVATED üî•');
            
            // Force UTC clock
            const clockEl = document.getElementById('utc-clock');
            if (clockEl) {
                const now = new Date();
                clockEl.textContent = `${now.toUTCString().slice(17, 25)} UTC`;
                console.log('‚úÖ UTC Clock forced');
            } else {
                console.log('‚ùå UTC Clock element not found');
            }
            
            // Force roster
            roster = ['Guardian1', 'Guardian2', 'Guardian3', 'Guardian4', 'Guardian5', 'Guardian6'];
            console.log('‚úÖ Roster forced:', roster);
            
            // Force immediate protection display
            const w3Status = document.getElementById('w3-status');
            const w3Guardians = document.getElementById('w3-guardians');
            const w3ShiftTime = document.getElementById('w3-shift-time');
            
            const w84Status = document.getElementById('w84-status');
            const w84Guardians = document.getElementById('w84-guardians');
            const w84ShiftTime = document.getElementById('w84-shift-time');
            
            if (w3Status && w3Guardians && w3ShiftTime) {
                w3Status.innerHTML = 'üõ°Ô∏è ACTIVE';
                w3Status.className = 'px-3 py-1 rounded-full text-sm bg-green-600 text-white';
                w3ShiftTime.textContent = 'FORCED ACTIVE';
                w3Guardians.innerHTML = '<span class="bg-gray-700 text-cyan-400 px-2 py-1 rounded-full text-xs">üó°Ô∏è Guardian1</span><span class="bg-gray-700 text-cyan-400 px-2 py-1 rounded-full text-xs">üó°Ô∏è Guardian2</span><span class="bg-gray-700 text-cyan-400 px-2 py-1 rounded-full text-xs">üó°Ô∏è Guardian3</span>';
                console.log('‚úÖ World 3 display forced');
            }
            
            if (w84Status && w84Guardians && w84ShiftTime) {
                w84Status.innerHTML = 'üõ°Ô∏è ACTIVE';
                w84Status.className = 'px-3 py-1 rounded-full text-sm bg-green-600 text-white';
                w84ShiftTime.textContent = 'FORCED ACTIVE';
                w84Guardians.innerHTML = '<span class="bg-gray-700 text-purple-400 px-2 py-1 rounded-full text-xs">üó°Ô∏è Guardian4</span><span class="bg-gray-700 text-purple-400 px-2 py-1 rounded-full text-xs">üó°Ô∏è Guardian5</span><span class="bg-gray-700 text-purple-400 px-2 py-1 rounded-full text-xs">üó°Ô∏è Guardian6</span>';
                console.log('‚úÖ World 84 display forced');
            }
            
            alert('üî• SUPER DEBUG COMPLETE! Both worlds should now show ACTIVE protection!');
        };

        // Make rerollSlot available globally for onclick handlers
        window.rerollSlot = rerollSlot;
    </script>
</body>
</html>